# Add custom settings here.
# please read https://pymumu.github.io/smartdns/config/basic-config/

# ===== 基本设置 =====
server-name smartdns

# 服务器配置仅绑定本地和局域网地址，避免暴露公网
# 普通DNS：535端口对应国内组，536端口对应海外组
bind 127.0.0.1:535 -group china -no-speed-check -no-dualstack-selection
bind 192.168.3.2:535 -group china -no-speed-check -no-dualstack-selection
bind 127.0.0.1:536 -group oversea -no-speed-check -no-dualstack-selection
bind 192.168.3.2:536 -group oversea -no-speed-check -no-dualstack-selection
# DoT：8753对应国内，8755对应海外
bind-tls 127.0.0.1:8753 -group china -no-speed-check -no-dualstack-selection
bind-tls 192.168.3.2:8753 -group china -no-speed-check -no-dualstack-selection
bind-tls 127.0.0.1:8755 -group oversea -no-speed-check -no-dualstack-selection
bind-tls 192.168.3.2:8755 -group oversea -no-speed-check -no-dualstack-selection
# DoH：6773对应国内组，6775对应海外组
bind-https 127.0.0.1:6773 -group china -no-speed-check -no-dualstack-selection
bind-https 192.168.3.2:6773 -group china -no-speed-check -no-dualstack-selection
bind-https 127.0.0.1:6775 -group oversea -no-speed-check -no-dualstack-selection
bind-https 192.168.3.2:6775 -group oversea -no-speed-check -no-dualstack-selection

# ===== 日志配置 =====
# 生产环境使用info级别，减少敏感信息记录
log-level info
log-size 128K
log-num 1
log-file /tmp/smartdns.log  

# ===== 缓存配置 =====
# 小容量缓存平衡性能与隐私
cache-size 1024  
# 禁止缓存持久化到磁盘
cache-persist no  
# 最小缓存时间
cache-checkpoint-time 60
# 最大缓存时间
cache-checkpoint-time 3600  
# 随机化TTL值，避免指纹追踪
rr-ttl 300-900  

# ===== 证书配置 =====
ca-file /etc/ssl/certs/ca-certificates.crt
ca-path /etc/ssl/certs/

# SSL证书文件路径（确保权限为600）
bind-cert-file /etc/smartdns/smartdns-cert.pem
bind-cert-key-file /etc/smartdns/smartdns-key.pem

# ===== DNS 处理策略 =====
serve-expired no
prefetch-domain no
force-AAAA-SOA yes
force-qtype-SOA 65
dualstack-ip-selection no

# 防泄漏设置禁用DNS缓存泄露
dnsmasq-lease-file /dev/null
  
# 仅返回最快响应，减少IP暴露
response-mode first-ping  

# ===== 防污染加固 =====
# 过滤私有IP网段，防止伪造响应
bogus-nxdomain 0.0.0.0/8
bogus-nxdomain 10.0.0.0/8
bogus-nxdomain 172.16.0.0/12
bogus-nxdomain 127.0.0.1/16
bogus-nxdomain 192.168.0.0/16        
bogus-nxdomain 169.254.0.0/16

# 设置Cloudflare IPV4别名映射
ip-set -name cloudflare-ipv4 -file /etc/smartdns/cloudflare-ipv4.txt

# ===== 域名规则 =====
# 国内域名规则
conf-file /etc/smartdns/domain-set/domains.china.smartdns.conf
conf-file /etc/smartdns/domain-set/proxy-domain-list.conf
hosts-file /etc/hosts

# 默认规则：其他域名使用海外组 
domain-rules -c /./ -group oversea

# 用于解析上游服务器域名，不参与普通查询，引导 DNS
server 119.29.29.29 -bootstrap-dns -exclude-default-group

# ===== 代理配置 =====
proxy-server socks5://127.0.0.1:7898 -name socks5

# ===== 海外 DNS 组 =====
server-tls 1.1.1.1:853 -spki-pin SPfg6FluPIlUc6a5h313BDCxQYNGX+THTy7ig5X3+VA= -group oversea -proxy socks5
server-https https://dns.google/dns-query -spki-pin FqTJ9EDN0dfkPCn9lqFb4ow08ePpSXqKDRMcqJ7sM0k= -group oversea -proxy socks5
server-https https://cloudflare-dns.com/dns-query -spki-pin SPfg6FluPIlUc6a5h313BDCxQYNGX+THTy7ig5X3+VA= -group oversea -proxy socks5

# 国外备用 DNS
server-tls 1.0.0.1:853 -spki-pin SPfg6FluPIlUc6a5h313BDCxQYNGX+THTy7ig5X3+VA= -group oversea -proxy socks5
server-tcp 8.8.8.8:53 -group oversea -proxy socks5

# ===== 国内 DNS 组 =====
# 仅用于解析 domains.china.smartdns.conf 列表中的域名
server-https https://223.5.5.5/dns-query -spki-pin pa14rFR/bBJ25OSjCswaXu6YKWgQ2BDY5jhRRicqeik= -group china -exclude-default-group
server-tls dot.360.cn:853 -spki-pin i9WtbILFhlaOnx0OLF9BCBZ2Wr1tisRc1YGmLHAAjQA= -group china -exclude-default-group
server-tls 120.53.53.53:853 -spki-pin 5TIMjgyMhA0qmPdK+AM9LX6vNI/9EPBydh/ZXdfcYmI= -group china -exclude-default-group

# 国内备用 DNS仅支持 UDP 查询
# server 119.29.29.29 -group china -exclude-default-group
# server 202.103.44.150 -group china -exclude-default-group
server 1.2.4.8 -group china -exclude-default-group
server 210.2.4.8 -group china -exclude-default-group

# ===== 其他配置文件 =====
conf-file /etc/smartdns/conf.d/anti-ad-smartdns.conf
